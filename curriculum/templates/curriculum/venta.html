{% extends 'curriculum/base.html' %}

{% block title %}Venta de Garage | Valeria Meza{% endblock %}

{% block content %}
<div class="fade-in relative pb-20">
    
    <!-- Bot√≥n del Carrito (Esquina Superior Derecha - Compacto y funcional) -->
    <div class="fixed top-8 right-8 z-[110] no-print">
        <button type="button" onclick="toggleCartModal()" class="relative bg-[#1a1a1a] text-white p-5 rounded-2xl shadow-xl hover:scale-110 hover:bg-pink-500 transition-all duration-500 group border-2 border-white">
            <i data-lucide="shopping-bag" size="24"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-pink-500 text-white text-[10px] font-black w-6 h-6 flex items-center justify-center rounded-full scale-0 transition-transform duration-500 shadow-md border border-white">0</span>
        </button>
    </div>

    <!-- Encabezado Limpio -->
    <div class="mb-12">
        <h2 class="text-5xl font-black italic uppercase tracking-tighter text-[#1a1a1a] leading-none">
            Venta de <span class="text-pink-500">Garage</span>
        </h2>
        <div class="h-1.5 w-16 bg-pink-400 mt-3 rounded-full"></div>
    </div>

    <!-- Grid de Productos (Conectado a la variable 'productos' de la BD) -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for item in productos %}
        <div class="bg-white p-6 rounded-[3rem] border border-gray-100 shadow-sm relative overflow-hidden group hover:shadow-xl transition-all duration-500 flex flex-col h-full {% if item.stock <= 0 %}opacity-60 grayscale-[0.3]{% endif %}">
            
            <!-- Estado Vendido (Stock 0) -->
            {% if item.stock <= 0 %}
            <div class="absolute inset-0 z-40 bg-white/60 flex items-center justify-center pointer-events-none">
                <div class="bg-[#1a1a1a] text-white px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest -rotate-6 shadow-lg border-2 border-pink-500">
                    Vendido
                </div>
            </div>
            {% endif %}

            <!-- Badge de Precio -->
            <div class="absolute right-5 top-5 z-20">
                <div class="bg-[#1a1a1a] text-white px-5 py-2 rounded-xl group-hover:bg-pink-500 transition-all shadow-md">
                    <span class="text-xl font-black tracking-tighter">${{ item.precio|floatformat:0 }}</span>
                </div>
            </div>

            <!-- Contenedor de Imagen Proporcional -->
            <div class="w-full h-48 mb-6 overflow-hidden rounded-3xl bg-gray-50/50 relative border border-gray-50 group-hover:bg-white transition-colors duration-500 p-3">
                {% if item.imagen %}
                    <img src="{{ item.imagen.url }}" 
                         alt="{{ item.nombre_producto|escape }}" 
                         class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-700">
                {% else %}
                    <div class="w-full h-full flex flex-col items-center justify-center text-gray-200">
                        <i data-lucide="image" size="32" class="mb-2 opacity-10"></i>
                        <span class="text-[8px] font-black uppercase tracking-widest">Sin Foto</span>
                    </div>
                {% endif %}
                <div class="absolute bottom-3 left-3 px-3 py-1 bg-white/90 backdrop-blur-md text-[#1a1a1a] rounded-lg text-[8px] font-black uppercase tracking-widest border border-white/50 shadow-sm z-30">
                    {{ item.estado }}
                </div>
            </div>
            
            <!-- Bloque de Texto e Informaci√≥n -->
            <div class="px-1 mb-6 flex-grow flex flex-col">
                <div class="flex items-center gap-2 mb-2">
                    <div class="h-1 w-4 bg-pink-400 rounded-full"></div>
                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Disponibles: {{ item.stock|default:0 }}</span>
                </div>
                
                <h3 class="text-2xl font-black uppercase text-gray-900 leading-tight mb-3 group-hover:text-pink-500 transition-colors pr-12">
                    {{ item.nombre_producto }}
                </h3>
                
                <!-- Descripci√≥n con Leer M√°s -->
                <div class="relative">
                    <p id="desc-{{ item.id }}" class="text-gray-500 text-sm font-medium italic leading-relaxed line-clamp-2 transition-all duration-500">
                        "{{ item.descripcion }}"
                    </p>
                    <button type="button" onclick="toggleDescription('{{ item.id }}')" id="btn-desc-{{ item.id }}" class="text-[9px] font-black uppercase text-pink-400 mt-2 hover:text-pink-600 transition-colors tracking-widest">
                        Leer m√°s +
                    </button>
                </div>
            </div>
            
            <!-- Pie de Tarjeta (Acciones) -->
            <div class="pt-5 border-t border-gray-50 flex flex-col gap-5 relative z-10 mt-auto">
                {% if item.stock > 0 %}
                <div class="flex items-center justify-between gap-4">
                    <!-- Selector de Unidades -->
                    <div class="flex items-center bg-gray-50 rounded-xl p-1 border border-gray-100">
                        <button type="button" onclick="decrementQty('{{ item.id }}')" class="p-2 hover:text-pink-500 transition-colors"><i data-lucide="minus" size="14"></i></button>
                        <input type="number" id="qty-{{ item.id }}" min="1" max="{{ item.stock|default:1 }}" value="1" class="bg-transparent w-10 text-center font-black text-xs outline-none" readonly>
                        <button type="button" onclick="incrementQty('{{ item.id }}')" class="p-2 hover:text-pink-500 transition-colors"><i data-lucide="plus" size="14"></i></button>
                    </div>
                    
                    <!-- Bot√≥n de Agregar (Conectado a JS) -->
                    <button 
                        type="button"
                        onclick="addToCart('{{ item.id }}', '{{ item.nombre_producto|escapejs }}', '{{ item.precio|default:0|floatformat:2 }}', '{% if item.imagen %}{{ item.imagen.url }}{% endif %}', 'qty-{{ item.id }}')"
                        class="flex-grow flex items-center justify-center gap-3 py-4 bg-[#1a1a1a] text-white rounded-2xl hover:bg-pink-500 transition-all duration-300 group/btn font-black text-[10px] uppercase tracking-widest shadow-lg active:scale-95"
                    >
                        Agregar <i data-lucide="shopping-cart" size="16" class="group-hover/btn:rotate-12 transition-transform"></i>
                    </button>
                </div>
                {% else %}
                <button type="button" disabled class="w-full py-4 bg-gray-100 text-gray-400 rounded-2xl font-black text-[10px] uppercase tracking-widest cursor-not-allowed border border-dashed border-gray-200">
                    Agotado
                </button>
                {% endif %}
                
                <div class="flex justify-between items-center opacity-30">
                    <span class="text-[9px] font-black uppercase tracking-tighter italic">Ref #{{ item.item_id }}</span>
                    <i data-lucide="sparkles" size="12" class="text-pink-400"></i>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full py-32 text-center bg-white rounded-[4rem] border border-dashed border-gray-100">
            <i data-lucide="tag" size="48" class="mx-auto mb-4 text-gray-200"></i>
            <p class="text-gray-400 font-bold uppercase tracking-widest text-xs italic">No hay productos en el cat√°logo actualmente</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL DEL CARRITO (Limpio y sin ruido)     -->
<!-- ========================================== -->

<div id="cart-modal" class="fixed inset-0 z-[150] hidden flex justify-end">
    <!-- Overlay transparente para cerrar sin ruido visual -->
    <div class="absolute inset-0 bg-transparent" onclick="toggleCartModal()"></div>
    
    <!-- Contenedor del Carrito -->
    <div class="relative w-full max-w-lg bg-white shadow-[-30px_0_60px_rgba(0,0,0,0.1)] flex flex-col animate-in slide-in-from-right duration-500">
        <div class="p-10 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
            <div>
                <h3 class="text-3xl font-black uppercase tracking-tighter text-gray-900 leading-none">Mi Bolsa</h3>
                <p id="modal-count" class="text-[10px] font-black text-pink-400 uppercase tracking-widest mt-2">0 Art√≠culos seleccionados</p>
            </div>
            <button type="button" onclick="toggleCartModal()" class="p-4 hover:bg-white rounded-2xl transition-all text-gray-400 hover:text-pink-500 shadow-sm border border-transparent hover:border-gray-100">
                <i data-lucide="x" size="24"></i>
            </button>
        </div>

        <div id="cart-items" class="flex-grow overflow-y-auto p-10 space-y-8 no-scrollbar scroll-smooth">
            <!-- Items generados din√°micamente -->
        </div>

        <div class="p-10 bg-white border-t border-gray-50 space-y-6">
            <div class="flex justify-between items-end">
                <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Total del Pedido</span>
                <span id="cart-total" class="text-4xl font-black tracking-tighter text-gray-900">$0</span>
            </div>
            
            <a id="whatsapp-checkout" href="#" target="_blank" class="w-full py-6 bg-[#1a1a1a] text-white rounded-[2.5rem] font-black uppercase text-xs tracking-[0.4em] flex items-center justify-center gap-4 hover:bg-pink-600 hover:-translate-y-1 transition-all duration-500 shadow-2xl">
                <i data-lucide="message-circle" size="20"></i>
                Completar Pedido
            </a>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- SCRIPTS DE L√ìGICA                          -->
<!-- ========================================== -->

<script>
    let cart = [];

    // --- L√≥gica para mostrar/ocultar descripci√≥n ---
    function toggleDescription(id) {
        const desc = document.getElementById('desc-' + id);
        const btn = document.getElementById('btn-desc-' + id);
        if (desc.classList.contains('line-clamp-2')) {
            desc.classList.remove('line-clamp-2');
            btn.innerText = 'Ver menos -';
        } else {
            desc.classList.add('line-clamp-2');
            btn.innerText = 'Leer m√°s +';
        }
    }

    // --- L√≥gica del Selector de Cantidad ---
    function incrementQty(id) {
        const input = document.getElementById('qty-' + id);
        if (input) {
            let max = parseInt(input.getAttribute('max')) || 0;
            let current = parseInt(input.value) || 1;
            if (current < max) input.value = current + 1;
        }
    }

    function decrementQty(id) {
        const input = document.getElementById('qty-' + id);
        if (input) {
            let current = parseInt(input.value) || 1;
            if (current > 1) input.value = current - 1;
        }
    }

    // --- Gesti√≥n del Modal y Sidebar ---
    function toggleCartModal() {
        const modal = document.getElementById('cart-modal');
        const sidebar = document.getElementById('main-sidebar');
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
            if (sidebar) sidebar.classList.add('opacity-0', 'pointer-events-none');
            renderCart();
        } else {
            if (sidebar) sidebar.classList.remove('opacity-0', 'pointer-events-none');
        }
    }

    // --- L√≥gica del Carrito ---
    function addToCart(id, name, price, image, inputId) {
        const input = document.getElementById(inputId);
        const qty = input ? parseInt(input.value) : 1;
        if (qty <= 0) return;
        
        const cleanPrice = parseFloat(price.replace(',', '.')) || 0;
        const existingItem = cart.find(i => i.id === id);
        
        if (existingItem) {
            existingItem.quantity += qty;
        } else {
            cart.push({ id, name, price: cleanPrice, image, quantity: qty });
        }
        
        updateCartBadge();
        
        const badge = document.getElementById('cart-count');
        if (badge) {
            badge.classList.remove('scale-100');
            setTimeout(() => badge.classList.add('scale-100'), 50);
        }
        if(input) input.value = 1;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
        updateCartBadge();
    }

    function updateCartBadge() {
        const badge = document.getElementById('cart-count');
        const modalCount = document.getElementById('modal-count');
        const totalItems = cart.reduce((acc, curr) => acc + curr.quantity, 0);
        if (badge) {
            badge.innerText = totalItems;
            if (totalItems > 0) {
                badge.classList.remove('scale-0');
                badge.classList.add('scale-100');
            } else {
                badge.classList.remove('scale-100');
                badge.classList.add('scale-0');
            }
        }
        if (modalCount) modalCount.innerText = `${totalItems} Unidades en bolsa`;
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        const totalEl = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('whatsapp-checkout');
        
        if (cart.length === 0) {
            container.innerHTML = `<div class="py-20 text-center text-gray-300 uppercase text-[10px] tracking-widest font-black opacity-50"><i data-lucide="shopping-bag" class="mx-auto mb-4" size="48"></i> Bolsa Vac√≠a</div>`;
            totalEl.innerText = "$0";
            checkoutBtn.classList.add('opacity-40', 'pointer-events-none');
            if (window.lucide) lucide.createIcons();
            return;
        }

        let subtotal = 0;
        container.innerHTML = cart.map((item, index) => {
            const lineTotal = item.price * item.quantity;
            subtotal += lineTotal;
            return `
                <div class="flex items-center gap-6 group/item animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="w-20 h-20 bg-gray-50 rounded-[1.8rem] overflow-hidden shrink-0 border border-gray-100 shadow-inner">
                        ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-200"><i data-lucide="image" size="20"></i></div>`}
                    </div>
                    <div class="flex-grow">
                        <h4 class="text-xs font-black uppercase text-gray-900 leading-tight mb-1">${item.name}</h4>
                        <p class="text-pink-500 font-bold text-[10px] uppercase tracking-widest">${item.quantity} x $${item.price.toFixed(0)}</p>
                    </div>
                    <button type="button" onclick="removeFromCart(${index})" class="p-3 text-gray-300 hover:text-red-500 transition-colors">
                        <i data-lucide="trash-2" size="20"></i>
                    </button>
                </div>
            `;
        }).join('');

        totalEl.innerText = `$${subtotal.toFixed(0)}`;
        checkoutBtn.classList.remove('opacity-40', 'pointer-events-none');
        
        const message = encodeURIComponent(`¬°Hola Valeria! üëã Me interesan estos art√≠culos de tu Boutique:\n\n` + 
            cart.map(i => `‚ú® ${i.quantity}x ${i.name} ($${i.price * i.quantity})`).join('\n') + 
            `\n\nüíµ *Total: $${subtotal}*`);
        
        const phone = "{% if perfil %}{{ perfil.telefono }}{% endif %}";
        checkoutBtn.href = `https://wa.me/${phone}?text=${message}`;
        if (window.lucide) lucide.createIcons();
    }
</script>

<style>
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    @keyframes slide-in-right { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .animate-in.slide-in-from-right { animation: slide-in-right 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
</style>

{% endblock %}